import streamlit as st
import pandas as pd
import plotly.express as px
import json
import re
from datetime import datetime

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
st.set_page_config(layout="wide", page_title="–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –æ—Ç–∑—ã–≤–æ–≤ –æ –ì–∞–∑–ø—Ä–æ–º–±–∞–Ω–∫–µ")

# –ó–∞–≥–æ–ª–æ–≤–æ–∫
st.title("–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –æ—Ç–∑—ã–≤–æ–≤ –æ –ì–∞–∑–ø—Ä–æ–º–±–∞–Ω–∫–µ")

# –°–∞–π–¥–±–∞—Ä –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ JSON
st.sidebar.header("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö")
uploaded_json = st.sidebar.file_uploader("–ó–∞–≥—Ä—É–∑–∏—Ç–µ JSON —Å –æ—Ç–∑—ã–≤–∞–º–∏", type=['json'])

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —Å —É—Ç–æ—á–Ω—ë–Ω–Ω—ã–º–∏ –≤–µ—Å–∞–º–∏
SENTIMENT_LEXICON = {
    'positive': {
        '–æ—Ç–ª–∏—á–Ω': 2, '—Ö–æ—Ä–æ—à': 2, '–ø—Ä–µ–∫—Ä–∞—Å–Ω': 2, '–±—ã—Å—Ç—Ä': 1, '—É–¥–æ–±–Ω': 1, '–ø–æ–Ω—è—Ç–Ω': 1,
        '—Ä–µ–∫–æ–º–µ–Ω–¥': 2, '–¥–æ–≤–æ–ª': 2, '—Å–ø–∞—Å–∏–±': 2, '—Ä–∞–¥': 2, '–ª–µ–≥–∫': 1, '–ø—Ä–∏—è—Ç–Ω': 1,
        '–∫–∞—á–µ—Å—Ç–≤–µ–Ω': 2, '–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª': 2, '–æ–ø–µ—Ä–∞—Ç–∏–≤': 1, '—á–µ—Ç–∫': 1, '–ø—Ä–æ–∑—Ä–∞—á–Ω': 1,
        '–≤—ã–≥–æ–¥–Ω': 2, '–Ω–∞–¥–µ–∂–Ω': 2, '–ª—É—á—à': 2, '—Å—É–ø–µ—Ä': 2, '–∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω': 2, '–≤–ø–µ—á–∞—Ç–ª': 2,
        '—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω': 2, '–ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å': 2, '–Ω—Ä–∞–≤–∏—Ç—Å—è': 2, '–≤–æ–≤—Ä–µ–º—è': 1, '—Å–≤–æ–µ–≤—Ä–µ–º–µ–Ω': 1,
        '–≥–ª–∞–¥–∫–æ': 1, '—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω': 1, '–±–µ–∑ –ø—Ä–æ–±–ª–µ–º': 2, '–Ω–µ –ø–ª–æ—Ö–æ': 1, '–±–µ–∑ –æ—à–∏–±–æ–∫': 2,
        '–Ω–µ –º–µ–¥–ª–µ–Ω': 1, '–Ω–µ –∑–∞–≤–∏—Å–∞–µ—Ç': 2
    },
    'negative': {
        '–ø–ª–æ—Ö': -2, '—É–∂–∞—Å–Ω': -3, '–º–µ–¥–ª–µ–Ω': -2, '–Ω–µ—É–¥–æ–±–Ω': -2, '—Å–ª–æ–∂–Ω': -2, '–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è': -3,
        '–ø—Ä–æ–±–ª–µ–º': -2, '–æ—à–∏–±–∫': -2, '–≥–ª—é–∫': -2, '–∑–∞–≤–∏—Å–∞': -2, '–Ω–µ —Ä–∞–±–æ—Ç': -3, '–æ—Ç–∫–∞–∑': -2,
        '–æ–±–º–∞–Ω': -3, '–¥–æ—Ä–æ–≥': -2, '–∫–æ–º–∏—Å—Å': -1, '–¥–æ–ª–≥': -2, '–Ω–µ—è—Å–Ω': -1, '–Ω–µ–ø–æ–ª–∞–¥–∫': -2,
        '–Ω–µ–¥–æ–≤–æ–ª': -2, '—Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω': -3, '–∫–æ—à–º–∞—Ä': -3, '–∑–∞–≤–∏—Å–∞–µ—Ç': -2, '–≤–∏—Å–Ω–µ—Ç': -2, '—Ç—É–ø–∏—Ç': -2,
        '–ª–∞–≥–∞–µ—Ç': -2, '–º–∞–ª–µ–Ω—å–∫': -1
    },
    'neutral': {
        '–Ω–æ—Ä–º–∞–ª—å–Ω': 0, '–æ–±—ã—á–Ω': 0, '—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω': 0, '–ø—Ä–∏–µ–º–ª–µ–º': 0, '–∏–∑–º–µ–Ω–µ–Ω': 0,
        '–æ–∂–∏–¥–∞': 0, '—Å—Ä–µ–¥–Ω': 0, '—Ä–∞–±–æ—Ç': 0, '–Ω–µ–π—Ç—Ä–∞–ª—å–Ω': 0
    }
}

INTENSIFIERS = {
    '–æ—á–µ–Ω—å': 1.5, '–∫—Ä–∞–π–Ω–µ': 2, '—Å–æ–≤—Å–µ–º': 1.5, '–∞–±—Å–æ–ª—é—Ç–Ω–æ': 2, '–ø–æ–ª–Ω–æ—Å—Ç—å—é': 1.5, '—Å–∏–ª—å–Ω–æ': 1.5,
    '—á—Ä–µ–∑–≤—ã—á–∞–π–Ω–æ': 2, '–Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ': 2, '—É–¥–∏–≤–∏—Ç–µ–ª—å–Ω–æ': 1.5, '–Ω–µ–æ–±—ã—á–Ω–æ': 1.5, '–≤–µ—Å—å–º–∞': 1.5,
    '—Å–ª–∏—à–∫–æ–º': 2, '—á–∞—Å—Ç–æ': 1
}

NEGATION_WORDS = {
    '–Ω–µ', '–Ω–µ—Ç', '–Ω–∏', '–±–µ–∑', '–Ω–µ–ª—å–∑—è', '–Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ', '–Ω–∏–∫–∞–∫', '–Ω–∏—á—É—Ç—å'
}

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ç–µ–º (topics)
PRODUCT_CATEGORIES_TOPICS = {
    '–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ': {
        'keywords': ['–æ–±—Å–ª—É–∂–∏–≤–∞–Ω', '–æ—Ç–¥–µ–ª–µ–Ω–∏', '–∫–ª–∏–µ–Ω—Ç', '–æ—á–µ—Ä–µ–¥', '–ø–µ—Ä—Å–æ–Ω–∞–ª', '–º–µ–Ω–µ–¥–∂–µ—Ä', '–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç', '–ø—Ä–∏–µ–º', '–∫–∞—Å—Å–∞', '–æ–ø–µ—Ä–∞—Ç–æ—Ä', '–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ'],
        'phrases': ['–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –≤ –±–∞–Ω–∫–µ', '–æ—Ç–¥–µ–ª–µ–Ω–∏–µ –±–∞–Ω–∫–∞', '–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä', '–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –≤ –±–∞–Ω–∫–µ', '–æ—á–µ—Ä–µ–¥—å –≤ –æ—Ç–¥–µ–ª–µ–Ω–∏–∏']
    },
    '–ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ': {
        'keywords': ['–º–æ–±–∏–ª—å', '–ø—Ä–∏–ª–æ–∂–µ–Ω', '–æ–Ω–ª–∞–π–Ω', '–∏–Ω—Ç–µ—Ä–Ω–µ—Ç', '—Å–º—Å', '–≥–ª—é–∫', '–∑–∞–≤–∏—Å–∞', '–Ω–µ —Ä–∞–±–æ—Ç', '—Ç–æ—Ä–º–æ–∑', '–≤–∏—Å–Ω–µ—Ç', '—Ç—É–ø–∏—Ç', '–ª–∞–≥–∞–µ—Ç'],
        'phrases': ['–º–æ–±–∏–ª—å–Ω—ã–π –±–∞–Ω–∫', '–º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', '–∏–Ω—Ç–µ—Ä–Ω–µ—Ç –±–∞–Ω–∫', '—Å–º—Å –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ', '–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≤–∏—Å–ª–æ']
    },
    '–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞': {
        'keywords': ['–∫—Ä–µ–¥–∏—Ç–Ω', '–ª–∏–º–∏—Ç', '–æ–¥–æ–±—Ä–µ–Ω', '–ø–æ–≥–∞—à–µ–Ω', '–ø—Ä–æ—Ü–µ–Ω—Ç', '–ø–ª–∞—Ç–µ–∂', '–∑–∞—è–≤–∫'],
        'phrases': ['–∫—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞', '–æ–¥–æ–±—Ä–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞', '–ø–æ–≥–∞—à–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞', '–∫—Ä–µ–¥–∏—Ç–Ω—ã–π –ª–∏–º–∏—Ç', '–æ—Ñ–æ—Ä–º–∏—Ç—å –∫–∞—Ä—Ç—É']
    }
}

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
PRODUCT_CATEGORIES_MAIN = {
    '–ü–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å—ã –∏ –ø–ª–∞—Ç–µ–∂–∏': {
        'subcategories': {
            '–í–µ–¥–µ–Ω–∏–µ –≤–∞–ª—é—Ç–Ω—ã—Ö —Å—á–µ—Ç–æ–≤': {'keywords': ['–≤–∞–ª—é—Ç', '—Ä—É–±–ª', '–¥–æ–ª–ª–∞—Ä', '–µ–≤—Ä–æ', '–≤–∞–ª—é—Ç–Ω', '—Å—á–µ—Ç', '–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü', '–æ–±–º–µ–Ω'], 'phrases': ['–≤–∞–ª—é—Ç–Ω—ã–π —Å—á–µ—Ç', '–æ–±–º–µ–Ω –≤–∞–ª—é—Ç—ã', '–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤–∞–ª—é—Ç—ã']},
            '–î–µ–±–µ—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã': {'keywords': ['–¥–µ–±–µ—Ç', '—Å–Ω—è—Ç–∏–µ', '–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ', '–∫—ç—à–±—ç–∫'], 'phrases': ['–¥–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞', '–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã', '—Å–Ω—è—Ç–∏–µ –Ω–∞–ª–∏—á–Ω—ã—Ö']},
            '–ú–æ–±–∏–ª—å–Ω—ã–π –±–∞–Ω–∫': {'keywords': ['–º–æ–±–∏–ª—å', '–ø—Ä–∏–ª–æ–∂–µ–Ω', '–æ–Ω–ª–∞–π–Ω', '–∏–Ω—Ç–µ—Ä–Ω–µ—Ç', '—Å–º—Å'], 'phrases': ['–º–æ–±–∏–ª—å–Ω—ã–π –±–∞–Ω–∫', '–º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', '–∏–Ω—Ç–µ—Ä–Ω–µ—Ç –±–∞–Ω–∫']},
            '–ü–µ—Ä–µ–≤–æ–¥—ã': {'keywords': ['–ø–µ—Ä–µ–≤–æ–¥', '—Å—Ä–µ–¥—Å—Ç–≤', '–¥–µ–Ω—å–≥', '–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ'], 'phrases': ['–ø–µ—Ä–µ–≤–æ–¥ –¥–µ–Ω–µ–≥', '–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤']},
            '–ó–∞—Ä–ø–ª–∞—Ç–Ω—ã–µ –∫–∞—Ä—Ç—ã': {'keywords': ['–∑–∞—Ä–ø–ª–∞—Ç', '–∑–∞—Ä–ø–ª–∞—Ç–Ω', '–≤—ã–ø–ª–∞—Ç–∞'], 'phrases': ['–∑–∞—Ä–ø–ª–∞—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞', '–≤—ã–ø–ª–∞—Ç–∞ –∑–∞—Ä–ø–ª–∞—Ç—ã']}
        },
        'keywords': ['–ø–µ—Ä–µ–≤–æ–¥', '–∑–∞—Ä–ø–ª–∞—Ç', '–º–æ–±–∏–ª—å', '–±–∞–Ω–∫', '–ø–ª–∞—Ç–µ–∂', '–≤–∞–ª—é—Ç', '—Ä—É–±–ª', '–¥–æ–ª–ª–∞—Ä', '–µ–≤—Ä–æ', '—Å–Ω—è—Ç', '–ø–æ–ª—É—á–µ–Ω', '–±–∞–Ω–∫–æ–º–∞—Ç', '–æ–ø–ª–∞—Ç', '–∫–≤–∏—Ç–∞–Ω—Ü', '–∫–æ–º–∏—Å—Å', '–æ–±—Å–ª—É–∂–≤–∞–Ω', '–æ—Ç–¥–µ–ª–µ–Ω–∏', '–∫–ª–∏–µ–Ω—Ç', '–æ—á–µ—Ä–µ–¥', '–æ–Ω–ª–∞–π–Ω', '–ø—Ä–∏–ª–æ–∂–µ–Ω', '–∏–Ω—Ç–µ—Ä–Ω–µ—Ç', '—Å–º—Å', '—É–≤–µ–¥–æ–º–ª–µ–Ω', '—Å—Ä–µ–¥—Å—Ç–≤', '–¥–µ–Ω—å–≥', '–Ω–∞–ª–∏—á', '–±–µ–∑–Ω–∞–ª', '—Å–±–µ—Ä–∫–Ω–∏–∂–∫', '–≤—ã–ø–∏—Å', '–±–∞–ª–∞–Ω—Å', '–æ—Å—Ç–∞—Ç–æ–∫'],
        'phrases': ['–∑–∞—Ä–ø–ª–∞—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞', '–º–æ–±–∏–ª—å–Ω—ã–π –±–∞–Ω–∫', '–ø–µ—Ä–µ–≤–æ–¥ –¥–µ–Ω–µ–≥', '–æ—Ç–∫—Ä—ã—Ç—å —Å—á–µ—Ç', '–≤–∞–ª—é—Ç–Ω—ã–π —Å—á–µ—Ç', '–±–∞–Ω–∫–æ–≤—Å–∫–∏–π —Å—á–µ—Ç', '—Ä–∞—Å—á–µ—Ç–Ω—ã–π —Å—á–µ—Ç', '—Å–Ω—è—Ç—å –¥–µ–Ω—å–≥–∏', '–ø–æ–ª—É—á–∏—Ç—å –¥–µ–Ω—å–≥–∏', '–æ–ø–ª–∞—Ç–∏—Ç—å —É—Å–ª—É–≥–∏', '–∫–æ–º–∏—Å—Å–∏—è –∑–∞ –ø–µ—Ä–µ–≤–æ–¥', '–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã', '–æ—Ç–¥–µ–ª–µ–Ω–∏–µ –±–∞–Ω–∫–∞', '–æ—á–µ—Ä–µ–¥—å –≤ –±–∞–Ω–∫–µ', '–∏–Ω—Ç–µ—Ä–Ω–µ—Ç –±–∞–Ω–∫', '–º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', '—Å–º—Å –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ', '–±–µ–∑–Ω–∞–ª–∏—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç', '–≤—ã–ø–∏—Å–∫–∞ –ø–æ —Å—á–µ—Ç—É', '–æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å—á–µ—Ç–µ']
    },
    '–°–±–µ—Ä–µ–∂–µ–Ω–∏—è –∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è': {
        'keywords': ['–≤–∫–ª–∞–¥', '—Å–±–µ—Ä–µ–≥–∞—Ç–µ–ª—å–Ω', '–Ω–∞–∫–æ–ø–∏—Ç', '—Å–±–µ—Ä–µ–∂–µ–Ω', '–º–µ—Ç–∞–ª–ª', '—Å—á–µ—Ç', '—Å—Ä–æ—á–Ω', '–ø—Ä–æ—Ü–µ–Ω—Ç', '–Ω–∞–∫–æ–ø', '—Å–±–µ—Ä–µ–≥', '–¥–µ–ø–æ–∑–∏—Ç', '—Å—Ç–∞–≤–∫', '–¥–æ—Ö–æ–¥–Ω–æ—Å—Ç', '–∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü', '–ø–æ–ø–æ–ª–Ω–µ–Ω', '—Å–Ω—è—Ç', '–ø—Ä–æ–ª–æ–Ω–≥–∞—Ü', '–ø—Ä–æ—Ü–µ–Ω—Ç—ã', '–Ω–∞—á–∏—Å–ª–µ–Ω', '–∑–∞–±—Ä–∞—Ç', '–ø–æ–ª—É—á–µ–Ω', '–∑–æ–ª–æ—Ç', '—Å–µ—Ä–µ–±—Ä', '–ø–ª–∞—Ç–∏–Ω', '–ø–∞–ª–ª–∞–¥', '—Å–ª–∏—Ç–∫', '—Å–±–µ—Ä–µ–≥–∞—Ç–µ–ª—å–Ω', '—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç', '–Ω–∞–∫–æ–ø–ª–µ–Ω', '–æ—Ç–∫—Ä—ã—Ç', '–∑–∞–∫—Ä—ã—Ç'],
        'phrases': ['—Å—Ä–æ—á–Ω—ã–π –≤–∫–ª–∞–¥', '—Å–±–µ—Ä–µ–≥–∞—Ç–µ–ª—å–Ω—ã–π —Å—á–µ—Ç', '–º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–π —Å—á–µ—Ç', '–æ—Ç–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥', '–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —Å—á–µ—Ç', '–æ–±–µ–∑–ª–∏—á–µ–Ω–Ω—ã–π –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–π', '–±–∞–Ω–∫–æ–≤—Å–∫–∏–π –≤–∫–ª–∞–¥', '–¥–µ–ø–æ–∑–∏—Ç–Ω—ã–π —Å—á–µ—Ç', '–ø—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞', '–¥–æ—Ö–æ–¥ –ø–æ –≤–∫–ª–∞–¥—É', '–∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤', '–ø–æ–ø–æ–ª–Ω–∏—Ç—å –≤–∫–ª–∞–¥', '—Å–Ω—è—Ç—å —Å–æ –≤–∫–ª–∞–¥–∞', '–ø—Ä–æ–ª–æ–Ω–≥–∞—Ü–∏—è –≤–∫–ª–∞–¥–∞', '–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤', '–∑–∞–±—Ä–∞—Ç—å –≤–∫–ª–∞–¥', '–æ—Ç–∫—Ä—ã—Ç—å –¥–µ–ø–æ–∑–∏—Ç', '–∑–æ–ª–æ—Ç–æ–π —Å–ª–∏—Ç–æ–∫', '—Å–±–µ—Ä–µ–≥–∞—Ç–µ–ª—å–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç', '–Ω–∞–∫–æ–ø–∏—Ç—å –¥–µ–Ω—å–≥–∏']
    },
    '–ö—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–∏–µ': {
        'keywords': ['–∫—Ä–µ–¥–∏—Ç', '–∏–ø–æ—Ç–µ–∫', '–∞–≤—Ç–æ–∫—Ä–µ–¥–∏—Ç', '—Ä–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω', '–∑–∞–µ–º', '–ø–ª–∞—Ç–µ–∂', '–ø—Ä–æ—Ü–µ–Ω—Ç', '—Å—Ç–∞–≤–∫', '–æ–¥–æ–±—Ä–µ–Ω', '–ø–æ–≥–∞—à–µ–Ω', '–≤–∑—è—Ç', '–æ—Ñ–æ—Ä–º–ª–µ–Ω', '–¥–æ–ª–≥', '–∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç', '–ø—Ä–æ—Å—Ä–æ—á–∫', '—à—Ç—Ä–∞—Ñ', '–ø–µ–Ω–∏', '—Ä–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü', '—Ä–µ—à–µ–Ω', '–æ—Ç–∫–∞–∑', '—É—Å–ª–æ–≤', '—Ç—Ä–µ–±–æ–≤–∞–Ω', '—Å–ø—Ä–∞–≤–∫', '–∑–∞—è–≤–∫', '–∞–Ω–∫–µ—Ç', '–∫—Ä–µ–¥–∏—Ç–Ω', '–∏—Å—Ç–æ—Ä–∏', '—Å–∫–æ—Ä–∏–Ω–≥', '–ª–∏–º–∏—Ç', '–ª—å–≥–æ—Ç–Ω', '–ø–µ—Ä–∏–æ–¥', '–≥—Ä–∞—Ñ–∏–∫', '–ø–ª–∞—Ç–µ–∂'],
        'phrases': ['–ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å—Å–∫–∏–π –∫—Ä–µ–¥–∏—Ç', '–∏–ø–æ—Ç–µ—á–Ω—ã–π –∫—Ä–µ–¥–∏—Ç', '–≤–∑—è—Ç—å –∫—Ä–µ–¥–∏—Ç', '–æ—Ñ–æ—Ä–º–∏—Ç—å –∫—Ä–µ–¥–∏—Ç', '–∫—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞', '—Ä–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞', '–∞–≤—Ç–æ–º–æ–±–∏–ª—å–Ω—ã–π –∫—Ä–µ–¥–∏—Ç', '–æ–¥–æ–±—Ä–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞', '–ø–æ–≥–∞—à–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞', '–∫—Ä–µ–¥–∏—Ç–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è', '–ø—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞', '–µ–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂', '–ª—å–≥–æ—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥', '–≥—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π', '–ø—Ä–æ—Å—Ä–æ—á–∫–∞ –ø–ª–∞—Ç–µ–∂–∞', '—à—Ç—Ä–∞—Ñ–Ω—ã–µ —Å–∞–Ω–∫—Ü–∏–∏', '—Ä–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏—è –¥–æ–ª–≥–∞', '–æ—Ç–∫–∞–∑ –≤ –∫—Ä–µ–¥–∏—Ç–µ', '–∫—Ä–µ–¥–∏—Ç–Ω–∞—è –∑–∞—è–≤–∫–∞', '—Å–ø—Ä–∞–≤–∫–∞ –æ –¥–æ—Ö–æ–¥–∞—Ö', '–∫—Ä–µ–¥–∏—Ç–Ω—ã–π –ª–∏–º–∏—Ç']
    },
    '–ü—Ä–µ–º–∏–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏': {
        'keywords': ['–ø—Ä–∏–≤–∞—Ç', '–ø—Ä–µ–º–∏—É–º', '–¥–µ–ø–æ–∑–∏—Ç–∞—Ä', '—è—á–µ–π–∫', '–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞–Ω', '–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω', '–ø–µ—Ä—Å–æ–Ω–∞–ª', '–º–µ–Ω–µ–¥–∂–µ—Ä', '—ç–∫—Å–∫–ª—é–∑–∏–≤', '–≤–∏–ø', '–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω', '–æ–±—Å–ª—É–∂–≤–∞–Ω', '—É—Å–ª—É–≥', '–±–æ–≥–∞—Ç', '—Å–æ—Å—Ç–æ—è–Ω', '–∫–∞–ø–∏—Ç–∞–ª', '–Ω–∞—Å–ª–µ–¥', '—Å–æ—Ö—Ä–∞–Ω', '–ø—Ä–∏—É–º–Ω–æ–∂–µ–Ω', '—É–ø—Ä–∞–≤–ª–µ–Ω', '–∞–∫—Ç–∏–≤', '—Ü–µ–Ω–Ω–æ—Å—Ç', '–¥—Ä–∞–≥–æ—Ü–µ–Ω–Ω–æ—Å—Ç', '—Ö—Ä–∞–Ω–µ–Ω', '–ø—Ä–∏–≤–∏–ª–µ–≥–∏', '—ç–ª–∏—Ç–Ω', '—Å–ø–µ—Ü–∏–∞–ª—å–Ω', '–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω', '–∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü', '–ø—Ä–µ—Ñ–µ—Ä–µ–Ω—Ü', '—Å–µ—Ä–≤–∏—Å', '–∫–æ–º–Ω–∞—Ç', '–∑–∞–ª', '–∑–æ–Ω–∞', '–ø—Ä–∏–µ–º–Ω', '–æ—Ñ–æ—Ä–º–ª–µ–Ω', '–¥–æ—Å—Ç—É–ø', '—É–Ω–∏–∫–∞–ª—å–Ω'],
        'phrases': ['–ø—Ä–∏–≤–∞—Ç-–±–∞–Ω–∫–∏–Ω–≥', '–ø—Ä–µ–º–∏—É–º-–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ', '–¥–µ–ø–æ–∑–∏—Ç–∞—Ä–Ω—ã–µ —É—Å–ª—É–≥–∏', '—Å–µ–π—Ñ–æ–≤–∞—è —è—á–µ–π–∫–∞', '–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä', '—ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ', 'VIP-—É—Å–ª—É–≥–∏', '–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥', '—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–æ–º', '–Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–∞', '—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–æ–≤', '–ø—Ä–∏—É–º–Ω–æ–∂–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤', '—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π', '–ø—Ä–µ–º–∏–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å', '–∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ', '—ç–ª–∏—Ç–Ω—ã–π –∑–∞–ª', '–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø', '—É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è', '–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç', '–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø—Ä–µ–º–∏—É–º-—É—Å–ª—É–≥']
    },
    '–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏': {
        'keywords': ['–∏–Ω–≤–µ—Å—Ç', '–±—Ä–æ–∫–µ—Ä', '–∏–∏—Å', '–ø–∏—Ñ', '–∞–∫—Ü–∏', '–æ–±–ª–∏–≥–∞—Ü', '–±–∏—Ä–∂', '–ø–æ—Ä—Ç—Ñ–µ–ª—å', '–¥–æ—Ö–æ–¥–Ω–æ—Å—Ç', '—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω', '–ø–∞–π', '—Ñ–æ–Ω–¥', '—Ü–µ–Ω–Ω', '–±—É–º–∞–≥', '—Ç–æ—Ä–≥–æ–≤', '—Å–¥–µ–ª–∫', '–∫—É–ø–ª—è', '–ø—Ä–æ–¥–∞–∂', '–∫–æ—Ç–∏—Ä–æ–≤–∫', '–¥–∏–≤–∏–¥–µ–Ω–¥', '–∫—É–ø–æ–Ω', '–≤—ã–ø–ª–∞—Ç', '—Ä–∏—Å–∫', '–ø—Ä–∏–±—ã–ª', '—É–±—ã—Ç–æ–∫', '–∞–Ω–∞–ª–∏–∑', '—Å–æ–≤–µ—Ç', '—É–ø—Ä–∞–≤–ª–µ–Ω', '–∏–Ω–≤–µ—Å—Ç–æ—Ä', '—Ç—Ä–µ–π–¥–µ—Ä', '–ª–∏—Ü–µ–Ω–∑', '–∫–æ–º–∏—Å—Å', '—Ç–∞—Ä–∏—Ñ'],
        'phrases': ['–±—Ä–æ–∫–µ—Ä—Å–∫–∏–π —Å—á–µ—Ç', '–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π —Å—á–µ—Ç', '–ø–∞–µ–≤–æ–π —Ñ–æ–Ω–¥', '—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç', '–∫—É–ø–∏—Ç—å –∞–∫—Ü–∏–∏', '–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–µ–Ω—å–≥–∏', '–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π —Å—á–µ—Ç', '—Ü–µ–Ω–Ω—ã–µ –±—É–º–∞–≥–∏', '—Ç–æ—Ä–≥–æ–≤–ª—è –Ω–∞ –±–∏—Ä–∂–µ', '–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π –ø–æ—Ä—Ç—Ñ–µ–ª—å', '–¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π', '–ø–æ–∫—É–ø–∫–∞ –∞–∫—Ü–∏–π', '–ø—Ä–æ–¥–∞–∂–∞ –æ–±–ª–∏–≥–∞—Ü–∏–π', '–¥–∏–≤–∏–¥–µ–Ω–¥–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã', '–∫—É–ø–æ–Ω–Ω—ã–π –¥–æ—Ö–æ–¥', '—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–º', '–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π —Ä–∏—Å–∫', '–±–∏—Ä–∂–µ–≤—ã–µ —Ç–æ—Ä–≥–∏', '–ª–∏—Ü–µ–Ω–∑–∏—è –±—Ä–æ–∫–µ—Ä–∞', '—Ç–∞—Ä–∏—Ñ—ã –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ', '–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è', '—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å–æ–≤–µ—Ç–Ω–∏–∫']
    }
}

# –§—É–Ω–∫—Ü–∏–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
def classify_sentiment(text):
    text = text.lower()
    sentiment_score = 0
    words = re.findall(r'\w+', text)
    for i, word in enumerate(words):
        base_score = 0
        for sentiment, keywords in SENTIMENT_LEXICON.items():
            for key, score in keywords.items():
                if key in word:
                    base_score = score
                    break
            if base_score != 0:
                break
        if base_score != 0:
            if i > 0 and words[i-1] in INTENSIFIERS:
                base_score *= INTENSIFIERS[words[i-1]]
            if i > 0 and words[i-1] in NEGATION_WORDS:
                base_score = -base_score
            sentiment_score += base_score
    return '–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ' if sentiment_score > 1 else '–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ' if sentiment_score < -1 else '–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ'

def classify_topics(text):
    text = text.lower()
    categories = set()
    words = set(re.findall(r'\w+', text))
    for category, data in PRODUCT_CATEGORIES_TOPICS.items():
        keywords = set(data['keywords'])
        phrases = set(data['phrases'])
        if any(word in keywords for word in words) or any(phrase in text for phrase in phrases):
            categories.add(category)
    return list(categories) if categories else ['–î—Ä—É–≥–æ–µ']

def classify_product_category(text, topics):
    text = text.lower()
    categories = set()
    words = set(re.findall(r'\w+', text))
    for category, data in PRODUCT_CATEGORIES_MAIN.items():
        keywords = set(data['keywords'])
        phrases = set(data['phrases'])
        if any(word in keywords for word in words) or any(phrase in text for phrase in phrases):
            categories.add(category)
    if len(categories) > 1 and '–î—Ä—É–≥–æ–µ' in categories:
        categories.remove('–î—Ä—É–≥–æ–µ')
    return list(categories) if categories else ['–î—Ä—É–≥–æ–µ']

def process_review(review):
    text = review.get('text', '')
    id = review.get('id', 0)
    parts = re.split(r'\b–Ω–æ\b', text, flags=re.IGNORECASE)
    parts = [p.strip() for p in parts if p.strip()]
    
    topics = []
    sentiments = []
    if parts:
        for part in parts:
            part_topics = classify_topics(part)
            sentiment = classify_sentiment(part)
            for topic in part_topics:
                if topic not in topics:
                    topics.append(topic)
                    sentiments.append(sentiment)
    else:
        topics = classify_topics(text)
        sentiment = classify_sentiment(text)
        sentiments = [sentiment] * len(topics)
    
    if len(topics) > 1 and '–î—Ä—É–≥–æ–µ' in topics:
        idx = topics.index('–î—Ä—É–≥–æ–µ')
        topics.pop(idx)
        sentiments.pop(idx)
    
    return {
        'id': id,
        'text': text,
        'topics': ', '.join(topics),
        'sentiments': ', '.join(sentiments),
        'product_category': ', '.join(classify_product_category(text, topics)),
        'date': datetime.now().strftime('%d.%m.%Y'),
        'rating': 3,  # –°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        'author': review.get('author', '–ö–ª–∏–µ–Ω—Ç –±–∞–Ω–∫–∞'),
        'source': 'gold'
    }

@st.cache_data
def load_data(uploaded_file):
    if uploaded_file is not None:
        data = json.load(uploaded_file)
        if 'data' in data and isinstance(data['data'], list):
            predictions = [process_review(review) for review in data['data']]
            df = pd.DataFrame(predictions)
            if not df.empty:
                df['date'] = pd.to_datetime(df['date'], format='%d.%m.%Y')
                st.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(df)} –æ—Ç–∑—ã–≤–æ–≤")
                return df
        st.error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON. –û–∂–∏–¥–∞–µ—Ç—Å—è {'data': [{'id': 1, 'text': '...'}]}")
    return pd.DataFrame()

if uploaded_json:
    df = load_data(uploaded_json)
else:
    df = pd.DataFrame()
    st.sidebar.warning("–ó–∞–≥—Ä—É–∑–∏—Ç–µ JSON —Å –æ—Ç–∑—ã–≤–∞–º–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞")

if not df.empty:
    # –¢–∞–±–ª–∏—Ü–∞ –æ—Ç–∑—ã–≤–æ–≤
    st.subheader("üìù –ü–æ–¥—Ä–æ–±–Ω—ã–µ –æ—Ç–∑—ã–≤—ã")
    st.dataframe(df)

    # –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
    st.subheader("üòä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏")
    if 'sentiments' in df:
        sentiment_counts = df['sentiments'].str.split(', ').explode().value_counts()
        fig_sentiment = px.pie(names=sentiment_counts.index, values=sentiment_counts.values, title="–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –æ—Ç–∑—ã–≤–æ–≤",
                              color=sentiment_counts.index,
                              color_discrete_map={'–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ': '#90EE90', '–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ': '#FF6347', '–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ': '#D3D3D3'})
        st.plotly_chart(fig_sentiment, use_container_width=True)
    else:
        st.write("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏.")

    # –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    st.subheader("üìã –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –ø—Ä–æ–¥—É–∫—Ç–æ–≤")
    if 'product_category' in df:
        product_counts = df['product_category'].str.split(', ').explode().value_counts()
        fig_product = px.bar(x=product_counts.index, y=product_counts.values, title="–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤",
                             color=product_counts.index,
                             color_discrete_map={
                                 '–ü–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å—ã –∏ –ø–ª–∞—Ç–µ–∂–∏': '#1f77b4',
                                 '–°–±–µ—Ä–µ–∂–µ–Ω–∏—è –∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è': '#ff7f0e',
                                 '–ö—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–∏–µ': '#2ca02c',
                                 '–ü—Ä–µ–º–∏–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏': '#9467bd',
                                 '–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏': '#d62728',
                                 '–î—Ä—É–≥–æ–µ': '#bcbd22'
                             })
        st.plotly_chart(fig_product, use_container_width=True)
    else:
        st.write("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π.")
else:
    st.write("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. –ó–∞–≥—Ä—É–∑–∏—Ç–µ JSON —Å –æ—Ç–∑—ã–≤–∞–º–∏.")
